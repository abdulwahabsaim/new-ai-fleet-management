<%- include('../partials/header') %>

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4 mt-4">
        <h1 class="h3 mb-0 text-dark"><%= vehicle.make %> <%= vehicle.model %></h1>
        <div>
            <a href="/vehicles/<%= vehicle._id %>/edit" class="btn btn-warning shadow-sm me-2">
                <i class="bi bi-pencil-square me-1"></i> Edit
            </a>
            <form action="/vehicles/<%= vehicle._id %>?_method=DELETE" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this vehicle?');">
                <button type="submit" class="btn btn-danger shadow-sm">
                    <i class="bi bi-trash me-1"></i> Delete
                </button>
            </form>
        </div>
    </div>

    <%- include('../partials/flash_messages') %>

    <div class="row">
        <!-- Left Column: Details & AI Prediction -->
        <div class="col-lg-5 mb-4">
            <!-- Details Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Vehicle Details</h6>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between"><strong>Year:</strong> <span><%= vehicle.year %></span></li>
                        <li class="list-group-item d-flex justify-content-between"><strong>VIN:</strong> <span><%= vehicle.vin %></span></li>
                        <li class="list-group-item d-flex justify-content-between"><strong>License Plate:</strong> <span><%= vehicle.licensePlate %></span></li>
                        <li class="list-group-item d-flex justify-content-between"><strong>Mileage:</strong> <span><%= vehicle.mileage.toLocaleString() %> km</span></li>
                        <li class="list-group-item d-flex justify-content-between"><strong>Status:</strong> <span class="badge bg-<%= vehicle.status === 'active' ? 'success' : 'warning' %>"><%= vehicle.status %></span></li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Avg. Fuel Efficiency:</strong> 
                            <% if (vehicle.averageFuelEfficiency) { %>
                                <span class="fw-bold"><%= vehicle.averageFuelEfficiency.toFixed(2) %> L/100km</span>
                            <% } else { %>
                                <span class="text-muted">No data</span>
                            <% } %>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- AI Card -->
            <div class="card shadow-sm">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">AI Health Score</h6>
                </div>
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <% 
                        let scoreColor = 'success';
                        if (vehicle.healthScore < 75) scoreColor = 'warning';
                        if (vehicle.healthScore < 50) scoreColor = 'danger';
                    %>
                    <h4 class="fw-bold">Vehicle Health: <span class="text-<%= scoreColor %>"><%= vehicle.healthScore %> / 100</span></h4>
                    <div class="progress" role="progressbar" aria-label="Health Score" aria-valuenow="<%= vehicle.healthScore %>" aria-valuemin="0" aria-valuemax="100" style="height: 20px;">
                        <div class="progress-bar bg-<%= scoreColor %>" style="width: <%= vehicle.healthScore %>%"></div>
                    </div>
                    <p class="mt-3"><%= vehicle.healthScoreMessage %></p>
                    <p class="text-muted small mt-auto mb-0">Last updated: <%= new Date(vehicle.healthScoreLastUpdated).toLocaleString() %></p>
                </div>
            </div>
        </div>

        <!-- Right Column: Maintenance History & Form -->
        <div class="col-lg-7 mb-4">
            <div class="card shadow-sm">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">Maintenance History</h6>
                </div>
                <div class="card-body">
                    <!-- Form to Add New Record -->
                    <form action="/vehicles/<%= vehicle._id %>/maintenance?_method=POST" method="POST" class="mb-4 p-3 border rounded bg-light-subtle">
                        <h6 class="mb-3">Log New Service Record</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="serviceDate" class="form-label">Service Date</label>
                                <input type="date" class="form-control" name="serviceDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="mileage" class="form-label">Mileage at Service</label>
                                <input type="number" class="form-control" name="mileage" value="<%= vehicle.mileage %>" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Service Description</label>
                            <input type="text" class="form-control" name="description" placeholder="e.g., Oil Change, Tire Rotation" required>
                        </div>
                        <div class="mb-3">
                            <label for="cost" class="form-label">Cost ($)</label>
                            <input type="number" step="0.01" class="form-control" name="cost" required>
                        </div>
                        <button type="submit" class="btn btn-success btn-sm">Add Record</button>
                    </form>

                    <!-- History Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Mileage</th>
                                    <th>Cost</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (vehicle.maintenanceRecords && vehicle.maintenanceRecords.length > 0) { %>
                                    <% vehicle.maintenanceRecords.forEach(rec => { %>
                                        <tr>
                                            <td><%= rec.serviceDate.toLocaleDateString() %></td>
                                            <td><%= rec.description %></td>
                                            <td><%= rec.mileage.toLocaleString() %> km</td>
                                            <td>$<%= rec.cost.toFixed(2) %></td>
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">No maintenance records logged.</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include('../partials/footer') %>